name: Update Download Badges

on:
  release:
    types: [published]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-total-downloads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Rebuild total downloads badge JSON
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const { owner, repo } = context.repo;
            const releases = await github.paginate(
              github.rest.repos.listReleases,
              { owner, repo, per_page: 100 }
            );

            let total = 0;
            for (const release of releases) {
              for (const asset of release.assets ?? []) {
                if (asset.name === "module.zip") {
                  total += Number(asset.download_count ?? 0);
                }
              }
            }

            fs.mkdirSync("badge", { recursive: true });
            fs.writeFileSync(
              "badge/total-downloads.json",
              JSON.stringify(
                {
                  schemaVersion: 1,
                  label: "TOTAL DOWNLOADS",
                  message: String(total),
                  color: "2b82fc"
                },
                null,
                2
              ) + "\n"
            );

            core.info(`Updated total module.zip downloads: ${total}`);

      - name: Create pull request for badge update
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update total downloads badge"
          branch: "automation/update-total-downloads-badge"
          delete-branch: true
          title: "chore: update total downloads badge"
          body: "Automated update of `badge/total-downloads.json`."
          add-paths: |
            badge/total-downloads.json
