name: Update Download Badges

on:
  release:
    types: [published]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-total-downloads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Rebuild total downloads badge JSON
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const { owner, repo } = context.repo;
            const releases = await github.paginate(
              github.rest.repos.listReleases,
              { owner, repo, per_page: 100 }
            );

            let total = 0;
            for (const release of releases) {
              for (const asset of release.assets ?? []) {
                if (asset.name === "module.zip") {
                  total += Number(asset.download_count ?? 0);
                }
              }
            }

            fs.mkdirSync("badge", { recursive: true });
            fs.writeFileSync(
              "badge/total-downloads.json",
              JSON.stringify(
                {
                  schemaVersion: 1,
                  label: "TOTAL DOWNLOADS",
                  message: String(total),
                  color: "2b82fc"
                },
                null,
                2
              ) + "\n"
            );

            core.info(`Updated total module.zip downloads: ${total}`);

      - name: Commit and push badge branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git diff --quiet -- badge/total-downloads.json; then
            if git ls-remote --exit-code --heads origin badge-data >/dev/null 2>&1; then
              echo "No badge changes detected."
              exit 0
            fi
            echo "No content change, but badge-data branch does not exist. Creating it."
            git checkout -B badge-data
            git push origin badge-data
            exit 0
          fi
          git checkout -B badge-data
          git add badge/total-downloads.json
          git commit -m "chore: update total downloads badge"
          git push --force-with-lease origin badge-data
